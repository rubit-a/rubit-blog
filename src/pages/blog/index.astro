---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 카테고리별로 그룹화
const postsByCategory = allPosts.reduce((acc, post) => {
	const parts = post.id.split('/');
	const category = parts.length > 1 ? parts[0] : '기타';
	if (!acc[category]) {
		acc[category] = [];
	}
	acc[category].push(post);
	return acc;
}, {} as Record<string, typeof allPosts>);

// 카테고리 이름 한글화
const categoryNames: Record<string, string> = {
	'spring': 'Spring',
	'react': 'React',
	'postgresql': 'PostgreSQL',
	'기타': '기타'
};
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
	<div class="blog-container">
		{Object.entries(postsByCategory).map(([category, posts]) => (
			<section class="category-section">
				<h2 class="category-title">{categoryNames[category] || category}</h2>
				<div class="swiper" data-category={category}>
					<div class="swiper-wrapper">
						{posts.map((post) => (
							<div class="swiper-slide">
								<a href={`/blog/${post.id}/`}>
									{post.data.heroImage && (
										<Image width={400} height={200} src={post.data.heroImage} alt="" />
									)}
									<h4 class="title">{post.data.title}</h4>
									<p class="date">
										<FormattedDate date={post.data.pubDate} />
									</p>
								</a>
							</div>
						))}
					</div>
					<div class="swiper-button-prev"></div>
					<div class="swiper-button-next"></div>
					<div class="swiper-pagination"></div>
				</div>
			</section>
		))}
	</div>
</BaseLayout>

<style>
	.blog-container {
		width: 960px;
		max-width: calc(100% - 2em);
		margin: 0 auto;
		padding: 2em 1em;
	}

	.category-section {
		margin-bottom: 4rem;
	}

	.category-title {
		font-size: 2rem;
		margin-bottom: 1.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 3px solid rgb(var(--accent));
		color: rgb(var(--black));
	}

	.swiper {
		width: 100%;
		height: auto;
		margin: 0;
		padding: 2rem 0;
		position: relative;
	}

	.swiper-wrapper {
		display: flex;
	}

	.swiper-slide {
		width: 320px;
		height: auto;
	}

	.swiper-slide * {
		text-decoration: none;
		transition: 0.2s ease;
	}

	.swiper-slide img {
		width: 100%;
		height: 200px;
		margin-bottom: 0.75rem;
		border-radius: 8px;
		object-fit: cover;
	}

	.swiper-slide a {
		display: block;
	}

	.title {
		margin: 0 0 0.5rem 0;
		color: rgb(var(--black));
		line-height: 1.3;
		font-size: 1.25rem;
	}

	.date {
		margin: 0;
		color: rgb(var(--gray));
		font-size: 0.9rem;
	}

	.swiper-slide a:hover h4,
	.swiper-slide a:hover .date {
		color: rgb(var(--accent));
	}

	.swiper-slide a:hover img {
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		transform: translateY(-2px);
	}

	.swiper-button-prev,
	.swiper-button-next {
		width: 50px;
		height: 50px;
		color: rgb(var(--accent));
		background: rgba(255, 255, 255, 0.95);
		border-radius: 50%;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		transition: all 0.3s ease;
		z-index: 10;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.swiper-button-prev:hover,
	.swiper-button-next:hover {
		background: rgba(255, 255, 255, 1);
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
		transform: scale(1.1);
	}

	.swiper-button-prev::after,
	.swiper-button-next::after {
		font-size: 12px;
		font-weight: bold;
		position: static;
		margin: 0;
	}

	.swiper-button-prev.swiper-button-disabled,
	.swiper-button-next.swiper-button-disabled {
		opacity: 0.4;
		cursor: not-allowed;
		background: rgba(255, 255, 255, 0.7);
	}

	.swiper-button-prev.swiper-button-disabled:hover,
	.swiper-button-next.swiper-button-disabled:hover {
		transform: none;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
	}

	.swiper-pagination-bullet-active {
		background: rgb(var(--accent));
	}

	@media (max-width: 960px) {
		.swiper-slide {
			width: 280px;
		}
	}

	@media (max-width: 720px) {
		.blog-container {
			width: 100%;
			padding: 1.5em 1em;
		}

		.category-section {
			margin-bottom: 3rem;
		}

		.category-title {
			font-size: 1.5rem;
		}

		.swiper-button-prev,
		.swiper-button-next {
			width: 40px;
			height: 40px;
		}

		.swiper-button-prev::after,
		.swiper-button-next::after {
			font-size: 10px;
		}

		.swiper-slide {
			width: 100%;
		}

		.title {
			font-size: 1.1rem;
		}
	}
</style>

<script>
	import Swiper from 'swiper';
	import { Navigation, Pagination } from 'swiper/modules';

	// 모든 swiper 컨테이너 초기화
	document.addEventListener('DOMContentLoaded', () => {
		const swipers = document.querySelectorAll('.swiper');

		swipers.forEach((swiperEl) => {
			new Swiper(swiperEl as HTMLElement, {
				modules: [Navigation, Pagination],
				slidesPerView: 1,
				spaceBetween: 20,
				navigation: {
					nextEl: swiperEl.querySelector('.swiper-button-next') as HTMLElement,
					prevEl: swiperEl.querySelector('.swiper-button-prev') as HTMLElement,
				},
				pagination: {
					el: swiperEl.querySelector('.swiper-pagination') as HTMLElement,
					clickable: true,
				},
				breakpoints: {
					640: {
						slidesPerView: 2,
						spaceBetween: 20,
					},
					960: {
						slidesPerView: 3,
						spaceBetween: 30,
					},
				},
			});
		});
	});
</script>
